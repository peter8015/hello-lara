[TOC]

> 一般的中间件产品，不包含kafka、redis、spring cloud生态，这些有单独的介绍
>
> \

# zookeeper

> 分布式协同

zookeeper是一个分布式的，开放源码的分布式应用程序==协调服务==，是google Chubby一个开源实现，也是==hadoop和HBase的重要组件==。功能包含配置服务、域名服务、分布式同步、组服务等。

``` flow
start=>start: start
op=>operation: ClientA
op1=>operation: ZServer(RootNode-c)
op2=>operation: ClientB
end=>end: end

op(right)->op1
op1(right)->op2
```



##  节点信息

- 持久节点、
- 临时节点：节点的生命周期与客户端会话绑定在一起。如果客户端会话丢失，那么该节点会自动清除。
- 顺序节点：给znode节点分配一个单调递增的整数。

## watch原理

zookeeper用znode存放数据，并且把c的值存储在里面，如果c的值被更新了，==如何通知clientA和ClientB呢？==

通过三个步骤来实现：

- ==客户端注册watcher==：客户端发送watcher到服务端进行注册时，会将这个watcher保存在本地的zk watchManager中，这样做是为了服务端响应后，从本地就可以获取watcher进行处理。
- ==服务端处理watcher==：服务端获取注册请求，==从dataTree中对应的znode里获取数据==。客户端接收服务端返回数据，服务端将watcher添加到watchManager中。
- ==客户端回调watcher==：服务端会发送==watcherEvent==事件，客户端用回调函数（sendTread）进行接收，会将事件发送给EventThread。然后通过eventType知道哪个watcher被响应了，从本地的zk WatchManager中取出watcher放到waitingEvent队列中等待处理。

<img src="https://i0.wp.com/tva1.sinaimg.cn/large/e6c9d24ely1h1d33qqbpkj216o0p040m.jpg" alt="image-20220402111221088" style="zoom:50%;" />



## version原理与使用//todo

多个客户端修改C的值，version用来保证分布式数据的原子性操作。--乐观锁解决方案
还有一种是利用znode的有序性，在值c下创建临时顺序节点，更新时按节点id作为优先级更行 更新。

## 会话的原理与使用

客户端和服务端进行通信称为会话，有四种状态：connectingf,connected,re..,re...

## 服务群组

- 问题：服务器依赖于zk服务器，如果==zk挂了怎么办？==
- 为提高zk的可用性，引入了==服务集群==的概念。zk客户端可以将事务请求发送给任意一台zk服务器，无论哪个服务器都会把==请求转交给领导者==。领导者将数据写入znode之前，会向zookeeper集群的其他跟随都==发送广播==消息。这里的广播用到了==zab协议，这是paxos协议的实践。说白了就是一两阶段提交。==
- 具体方式如下：
  - 当集群==领导者==接收到==提交消息==后，向集群跟随都发送一个proposal
  - 当集群跟随者接收到propoal后，向领导者==反馈一个ack==，表示接收到proposal，并且已经做准备好。
  - 领导者进行==仲裁==，如果接收到数量过半的跟随者发送的ack信息（包括领导者自己），就发送消息通知跟随者进行提交。接下来跟随者把数据写入到znode中。
- 还有一个问题，==zk如何处理这么多的请求呢？==这就用到了观察者。

<img src="https://i0.wp.com/tva1.sinaimg.cn/large/e6c9d24ely1h1g4ybj4krj21f60oigof.jpg" alt="image-20220402113234090" style="zoom:50%;" />

## zab 协议（看分布式协同部分-zab算法）

[https://blog.csdn.net/langzhouxing/article/details/103741247](https://blog.csdn.net/langzhouxing/article/details/103741247)

## Zookeeper集群“脑裂”问题处理大全    //todo 还需要详细梳理总结

https://blog.csdn.net/mingongge/article/details/112417207



## Zookeeper集群节点为什么要部署成奇数

1. zab选举机制要求有超过半数的节点投票才可以==选举出leader==，所以zk最大的容错是宕机的节点个数必须小于剩余节点的个数。这样容错机器个数的前提下，最能节省资源。2n和2n-1的容忍度是一样的，都是n-1，所以为了更加高效，何必增加那一个不必要的Zookeeper呢。

## zookeeper脑裂指的是什么？

部署在两个机房的zk集群，网络出现中断情况，分别进行选举产生各自的leader，这种情况就是脑裂。两个集群都对外提供服务，数据就会出现不一致的情况。不过因为集群leader选举的过半机制，所以很少出现脑裂的现象。

## 选举机制中为什么是大于n/2，而不是等于n/2

主要用来防止脑裂现象。如果是五个节点组成的集群，A机房三个节点，B机房两个节点，这样在出现脑裂时，A机房节点数 > 3，可以选举出leader，B机房两个节点不能选举，zk还能正常提供服务。



## 如何解决"脑裂"问题的？

- Quorums (==法定人数==) 方式: 比如3个节点的集群，Quorums = 2, 也就是说集群可以容忍1个节点失效，这时候还能选举出1个lead，集群还可用。比如4个节点的集群，它的Quorums = 3，Quorums要超过3，相当于集群的容忍度还是1，如果2个节点失效，那么整个集群还是无效的。这是Zookeeper防止"脑裂"默认采用的方法；
- Redundant communications (==冗余通信==)方式：集群中采用多种通信方式，防止一种通信方式失效导致集群中的节点无法通信。
- Fencing (==共享资源==) 方式：比如能看到共享资源就表示在集群中，能够获得共享资源的锁的就是Leader，看不到共享资源的，就不在集群中。
- 仲裁机制方式；
- 启动磁盘锁定方式。

## Dubbo





# netty

> [https://ke.qq.com/course/3293405?taid=11073426419761373](https://ke.qq.com/course/3293405?taid=11073426419761373)

## 1. netty 是什么？为什么要用netty？

- 一个高性能、异步事件驱动的 NIO 框架，它提供了对 TCP、 UDP 和文件传输的支持使用更高效的 socket 底层。

- 对 epoll 空轮询引起的 cpu 占用飙升在内部进行了处理，避免了直接使用 NIO 的陷阱，简化了 NIO 的处理方式。

- 采用多种 decoder/encoder 支持，对TCP 粘包/分包进行自动化处理。可使用接受/处理线程池，提高连接效率，对重连、心跳检

  测的简单支持可配置 IO 线程数、 TCP 参数， TCP 接收和发送缓冲区使用直接内存代替堆内存。

- 通过内存池的方式循环利用 ByteBuf 通过引用计数器及时申请释放不再引用的对象，降低了 GC 频率使用单线程串行化的方式，高效的 Reactor 线程模型大量使用了volitale、使用了 CAS 和原子类、线程安全类的使用、读写锁的使用来保证框架的安全性。

- 支持多种协议：比如 FTP、SMTP,HTTP 等，以及各种支持二进制和基文本的传统传输协议。



## 2. netty 核心组件是什么？作用是什么？

## netty的线程模型是什么？

## **5. TCP 粘包/拆包的原因及解决方法？**

## netty 零拷贝了解吗？

原理是指在处理网络数据时，尽可能地减少数据在操作系统内核态与用户态之间复制的次数，以提升 I/O 性能。

- DMA传输：当网络数据到达时，网卡使用Direct Memory Access (DMA) 直接将数据写入内核空间的缓冲区，无需 CPU 参与数据的拷贝。

- 事件通知：当数据准备好后，操作系统通过 epoll 或者 kqueue 等机制触发 Socket 读取事件通知 Netty。

- 内存映射：Netty 使用 mmap 系统调用将内核缓冲区映射到用户空间，这样可以直接在用户态对数据进行操作，避免了数据从内核态到用户态的拷贝。
- ByteBuf 操作：Netty 使用其自定义的 ByteBuf 结构来封装和处理这些数据，所有的读写操作都在内存映射区域完成，进一步减少了内存拷贝。
- sendFile：对于文件传输等场景，Netty 还可以利用 sendFile 系统调用来直接将磁盘上的文件内容传输到网卡缓存中，这一过程同样避免了将文件数据先复制到用户态再复制到内核态的过程，实现了真正的零拷贝。
通过以上方式，Netty 实现了高效的数据处理，极大地提高了系统的吞吐量和性能。

## netty 长连接，心跳机制了解吗？











# shell

1. 用 awk 统计一个 ip 文件中 top10



# etcd

# 04 | Raft协议：etcd如何实现高可用、数据强一致的？

