

[toc]



# SpringCloud+Sentinel

https://www.jianshu.com/p/c47dfd25eeee



1. 添加依赖
在 Spring Boot 项目的 pom.xml 中添加 Sentinel 相关依赖：

``` xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
    <version>最新稳定版本</version>
</dependency>

```

2. 配置 Sentinel
   在 application.properties 或 application.yml 文件中添加 Sentinel 的基本配置：

``` properties
spring.cloud.sentinel.transport.server-port=8719 # Sentinel 控制台通信端口，默认为 8719
spring.cloud.sentinel.datasource.type=file # 数据源类型，这里以文件为例
spring.cloud.sentinel.datasource.file.filename=classpath:sentinel-rules.json # 配置规则文件路径

```

3. 创建资源限流规则
  创建 sentinel-rules.json 文件并在其中编写资源限流规则，如流量控制（QPS）、熔断降级等规则。

4. 使用 Sentinel 注解
  在需要保护的 REST 接口方法上使用 Sentinel 提供的注解，例如使用 @SentinelResource 注解来进行资源定义和处理降级逻辑：

  ``` java
  import com.alibaba.csp.sentinel.annotation.SentinelResource;
  import org.springframework.web.bind.annotation.GetMapping;
  import org.springframework.web.bind.annotation.RestController;
  
  @RestController
  public class ExampleController {
  
      @GetMapping("/example")
      @SentinelResource(value = "exampleApi", blockHandler = "handleException") // 设置资源名称和降级处理方法
      public String exampleApi() {
          // 业务逻辑代码
          return "Hello from example API!";
      }
  
      public String handleException(BlockException ex) { // 降级处理方法
          return "Service unavailable due to sentinel flow control.";
      }
  }
  
  ```

  5. 动态规则管理
    在 Sentinel 控制台上可以动态管理和监控资源的限流规则，无需重启服务即可生效。

  6. 全局统一处理异常
    还可以全局配置一个 fallback 函数，用于处理所有受 Sentinel 保护的资源在触发限流、降级等异常情况时的行为：

    ``` java
    import com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.BlockExceptionHandler;
    import org.springframework.context.annotation.Configuration;
    
    @Configuration
    public class SentinelConfig implements BlockExceptionHandler {
    
        @Override
        public void handle(HttpServletRequest request, HttpServletResponse response, BlockException e) throws Exception {
            response.setContentType("application/json;charset=UTF-8");
            PrintWriter out = response.getWriter();
            out.write("{\"code\": 503, \"message\": \"Service Unavailable\"}");
            out.flush();
            out.close();
        }
    }
    
    ```

    这样就完成了 Spring Cloud 与 Sentinel 的基础整合，并在 Java 代码中实现了资源的限流保护和降级处理。根据 Sentinel 更丰富的特性，您还可以配置系统规则、热点参数限流等更多高级功能。

![image-20240402164413378](https://p.ipic.vip/upzv63.png)



# SpringCloud+Zipkin+Sleuth实现分布式链路追踪

1. 添加依赖
   在 Spring Boot 项目的 pom.xml 中添加以下依赖：

   ``` xml
   <dependencies>
       <!-- Spring Boot Web Starter -->
       <dependency>
           <groupId>org.springframework.boot</groupId>
           <artifactId>spring-boot-starter-web</artifactId>
       </dependency>
   
       <!-- Spring Cloud Dependencies BOM for easier dependency management -->
       <dependencyManagement>
           <dependencies>
               <dependency>
                   <groupId>org.springframework.cloud</groupId>
                   <artifactId>spring-cloud-dependencies</artifactId>
                   <version>最新稳定版本</version> <!-- 替换为当前最新的Spring Cloud Hoxton或者更高版本 -->
                   <type>pom</type>
                   <scope>import</scope>
               </dependency>
           </dependencies>
       </dependencyManagement>
   
       <!-- Spring Cloud Sleuth and Zipkin Integration -->
       <dependency>
           <groupId>org.springframework.cloud</groupId>
           <artifactId>spring-cloud-starter-sleuth</artifactId>
       </dependency>
       <dependency>
           <groupId>org.springframework.cloud</groupId>
           <artifactId>spring-cloud-starter-zipkin</artifactId>
       </dependency>
   </dependencies>
   
   ```

2. 配置Zipkin Server
   在 application.properties 或 application.yml 中配置 Zipkin 服务器地址：

   ``` properties
   # application.properties
   spring.zipkin.baseUrl=http://localhost:9411
   spring.sleuth.sampler.probability=1.0 # 设置采样率为100%（生产环境根据实际情况调整）
   
   ```

3. 启动 Zipkin Server
   确保你已经安装并运行了 Zipkin Server。你可以通过 Docker 快速启动一个本地 Zipkin Server：

   ``` shell
   docker run -d -p 9411:9411 openzipkin/zipkin
   ```

   

4. 使用 Sleuth 进行追踪
   Sleuth 会自动注入追踪信息到 HTTP 请求头中，因此不需要手动处理大部分的追踪操作。然而，如果你需要手动创建或操作 Span，可以如下所示：

   ``` java
   import brave.Span;
   import brave.Tracer;
   import org.springframework.beans.factory.annotation.Autowired;
   import org.springframework.web.bind.annotation.GetMapping;
   import org.springframework.web.bind.annotation.RestController;
   
   @RestController
   public class MyController {
   
       @Autowired
       private Tracer tracer;
   
       @GetMapping("/api/example")
       public String exampleEndpoint() {
           // 创建一个新的 Span
           Span span = tracer.nextSpan().name("custom-operation");
           try (Tracer.SpanInScope ws = tracer.withSpanInScope(span.start())) {
               // 执行业务逻辑
               span.tag("key", "value"); // 添加自定义标签
               return "Response from custom operation";
           } finally {
               span.finish(); // 结束 Span
           }
       }
   }
   
   ```

   

   5. 验证整合效果
      启动你的 Spring Boot 应用，并进行一些请求调用。然后访问 Zipkin UI（通常是在 http://localhost:9411/），你应该能看到服务间的调用链路和时间消耗等信息。
      请注意，上述配置和示例适用于 Spring Cloud 和 Zipkin 的较早版本，具体细节可能因不同版本而有所差异，请参照对应版本的官方文档进行配置。

